# Test workflow for the npm-binary-scanner action itself
name: Test Action

on:
  push:
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test-scan-only:
    name: Test Scan Only
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create test project
        run: |
          mkdir -p test-project
          cd test-project
          npm init -y
          npm install esbuild --save-dev

      - name: Run Binary Scanner (scan only)
        uses: ./
        id: scan
        with:
          scan-path: 'test-project'
          deep-scan: 'true'

      - name: Check results
        run: |
          echo "Total packages with binaries: ${{ steps.scan.outputs.total-packages }}"
          echo "Total binary files: ${{ steps.scan.outputs.total-binaries }}"
          cat test-project/binary-scan-results.json

  test-with-upload:
    name: Test With Upload (Smart Deduplication)
    runs-on: ubuntu-latest
    needs: test-scan-only
    # Only run upload test on push (API key is available from secrets)
    if: ${{ github.event_name == 'push' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create test project
        run: |
          mkdir -p test-project
          cd test-project
          npm init -y
          npm install esbuild --save-dev

      - name: Run Binary Scanner (with upload - smart deduplication)
        uses: ./
        id: scan
        with:
          scan-path: 'test-project'
          deep-scan: 'true'
          upload: 'true'
          api-key: ${{ secrets.UC_API_KEY }}

      - name: Check results
        run: |
          echo "=== Scan Results ==="
          echo "Total packages with binaries: ${{ steps.scan.outputs.total-packages }}"
          echo "Total binary files: ${{ steps.scan.outputs.total-binaries }}"
          echo ""
          echo "=== Upload Results ==="
          echo "Uploaded successfully: ${{ steps.scan.outputs.upload-successful }}"
          echo "Upload failures: ${{ steps.scan.outputs.upload-failed }}"
          echo "Skipped (already exist): ${{ steps.scan.outputs.upload-skipped }}"
          echo ""
          echo "=== Threat Assessment ==="
          echo "Threats found (HIGH/MEDIUM): ${{ steps.scan.outputs.threats-found }}"

      - name: Add to job summary
        run: |
          echo "## Binary Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Packages with binaries | ${{ steps.scan.outputs.total-packages }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Total binary files | ${{ steps.scan.outputs.total-binaries }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Uploaded | ${{ steps.scan.outputs.upload-successful }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Skipped (existing) | ${{ steps.scan.outputs.upload-skipped }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Failed | ${{ steps.scan.outputs.upload-failed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ⚠️ Threats (HIGH/MEDIUM) | ${{ steps.scan.outputs.threats-found }} |" >> $GITHUB_STEP_SUMMARY

      - name: Show detailed results
        run: |
          echo "=== Detailed JSON Results ==="
          cat test-project/binary-scan-results.json | head -100

  test-force-upload:
    name: Test Force Upload (No Deduplication)
    runs-on: ubuntu-latest
    needs: test-with-upload
    # Run only on pushes (API key available from secrets)
    if: ${{ github.event_name == 'push' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create test project with small package
        run: |
          mkdir -p test-project
          cd test-project
          npm init -y
          # Use a smaller package for force upload test
          npm install @esbuild/linux-x64 --save-dev --ignore-scripts || true

      - name: Run Binary Scanner (force upload)
        uses: ./
        id: scan
        with:
          scan-path: 'test-project'
          upload: 'true'
          skip-existing: 'false'
          api-key: ${{ secrets.UC_API_KEY }}

      - name: Check force upload results
        run: |
          echo "=== Force Upload Results ==="
          echo "Uploaded: ${{ steps.scan.outputs.upload-successful }}"
          echo "Failed: ${{ steps.scan.outputs.upload-failed }}"
          echo "Skipped: ${{ steps.scan.outputs.upload-skipped }}"
          # With force upload, skipped should be 0
          if [ "${{ steps.scan.outputs.upload-skipped }}" != "0" ]; then
            echo "Warning: Expected 0 skipped files with force upload"
          fi

  test-no-reputations:
    name: Test Fast Mode (No Reputation Checks)
    runs-on: ubuntu-latest
    needs: test-scan-only
    # Run only on pushes (API key available from secrets)
    if: ${{ github.event_name == 'push' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create test project
        run: |
          mkdir -p test-project
          cd test-project
          npm init -y
          npm install esbuild --save-dev

      - name: Run Binary Scanner (no reputation checks)
        uses: ./
        id: scan
        with:
          scan-path: 'test-project'
          upload: 'true'
          get-reputations: 'false'
          api-key: ${{ secrets.UC_API_KEY }}

      - name: Check results
        run: |
          echo "=== Fast Mode Results ==="
          echo "Uploaded: ${{ steps.scan.outputs.upload-successful }}"
          echo "Skipped: ${{ steps.scan.outputs.upload-skipped }}"
          echo "Threats found: ${{ steps.scan.outputs.threats-found }}"
          # With no reputation checks, threats-found should be 0
          if [ "${{ steps.scan.outputs.threats-found }}" != "0" ]; then
            echo "Warning: Expected 0 threats with reputation checks disabled"
          fi

  test-cli:
    name: Test CLI Direct Usage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create test project
        run: |
          mkdir -p test-project
          cd test-project
          npm init -y
          npm install esbuild --save-dev

      - name: Test CLI scan
        run: |
          node scanner.js test-project
          cat test-project/binary-scan-results.json

      - name: Test CLI deep scan
        run: |
          node scanner.js --deep test-project

      - name: Test CLI help
        run: |
          node scanner.js --help

  test-cli-with-upload:
    name: Test CLI With Upload
    runs-on: ubuntu-latest
    needs: test-cli
    if: ${{ github.event_name == 'push' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create test project
        run: |
          mkdir -p test-project
          cd test-project
          npm init -y
          npm install @esbuild/linux-x64 --save-dev --ignore-scripts || true

      - name: Test CLI upload with deduplication
        env:
          UC_API_KEY: ${{ secrets.UC_API_KEY }}
          UC_API_URL: https://api.unknowncyber.com
        run: |
          node scanner.js --upload test-project

      - name: Test CLI force upload
        env:
          UC_API_KEY: ${{ secrets.UC_API_KEY }}
          UC_API_URL: https://api.unknowncyber.com
        run: |
          node scanner.js --upload --force-upload test-project

      - name: Test CLI no reputations
        env:
          UC_API_KEY: ${{ secrets.UC_API_KEY }}
          UC_API_URL: https://api.unknowncyber.com
        run: |
          node scanner.js --upload --no-reputations test-project

  test-yara-binaries:
    name: Test YARA on Binaries
    runs-on: ubuntu-latest
    needs: test-scan-only
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create test project
        run: |
          mkdir -p test-project
          cd test-project
          npm init -y
          npm install esbuild --save-dev

      - name: Run Scanner with YARA (binaries)
        uses: ./
        id: scan
        with:
          scan-path: 'test-project'
          deep-scan: 'true'
          yara-scan: 'true'

      - name: Check YARA results
        run: |
          echo "=== Scan Results ==="
          echo "Total binaries: ${{ steps.scan.outputs.total-binaries }}"
          echo ""
          echo "=== YARA Results ==="
          echo "Files with YARA matches: ${{ steps.scan.outputs.yara-matches }}"
          echo "High severity matches: ${{ steps.scan.outputs.yara-high-severity }}"
          
          if [ -f "test-project/yara-results.json" ]; then
            echo ""
            echo "=== YARA Results JSON ==="
            cat test-project/yara-results.json
          fi

  test-yara-js:
    name: Test YARA on JavaScript
    runs-on: ubuntu-latest
    needs: test-yara-binaries
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create test project
        run: |
          mkdir -p test-project
          cd test-project
          npm init -y
          npm install lodash --save  # Has JS files to scan

      - name: Run Scanner with YARA (JS files)
        uses: ./
        id: scan
        with:
          scan-path: 'test-project'
          yara-scan: 'true'
          yara-include: '*.js'

      - name: Check YARA JS results
        run: |
          echo "=== YARA JS Scan Results ==="
          echo "Files with YARA matches: ${{ steps.scan.outputs.yara-matches }}"
          echo "High severity matches: ${{ steps.scan.outputs.yara-high-severity }}"
          
          if [ -f "test-project/yara-results.json" ]; then
            echo ""
            echo "=== Files scanned ==="
            cat test-project/yara-results.json | head -20
          fi

  test-yara-cli:
    name: Test YARA CLI
    runs-on: ubuntu-latest
    needs: test-yara-js
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install yara-python
        run: pip install yara-python>=4.3.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create test project
        run: |
          mkdir -p test-project
          cd test-project
          npm init -y
          npm install esbuild --save-dev

      - name: Run binary scanner
        run: node scanner.js --deep test-project

      - name: Test YARA scanner help
        run: python yara_scanner.py --help

      - name: Test YARA scanner with results
        run: |
          python yara_scanner.py \
            --input test-project/binary-scan-results.json \
            --output test-project/yara-results.json \
            --github-annotations

      - name: Show YARA results
        run: cat test-project/yara-results.json

  test-include-package-json:
    name: Test Include package.json
    runs-on: ubuntu-latest
    needs: test-scan-only
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create test project
        run: |
          mkdir -p test-project
          cd test-project
          npm init -y
          npm install esbuild lodash@4.17.20 --save-dev

      - name: Run Scanner with package.json
        uses: ./
        id: scan
        with:
          scan-path: 'test-project'
          deep-scan: 'true'
          include-package-json: 'true'

      - name: Check results
        run: |
          echo "=== Scan Results ==="
          echo "Total packages: ${{ steps.scan.outputs.total-packages }}"
          echo "Total binaries: ${{ steps.scan.outputs.total-binaries }}"
          
          echo ""
          echo "=== Checking for package.json files ==="
          METADATA_COUNT=$(node -e "const r = require('./test-project/binary-scan-results.json'); console.log(r.totalMetadata || 0)")
          echo "Metadata files (package.json): $METADATA_COUNT"
          
          if [ "$METADATA_COUNT" -eq "0" ]; then
            echo "::error::Expected package.json files to be included"
            exit 1
          fi
          
          echo ""
          echo "=== Full JSON Results ==="
          cat test-project/binary-scan-results.json

  test-include-all-files:
    name: Test Include All Files
    runs-on: ubuntu-latest
    needs: test-include-package-json
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create test project
        run: |
          mkdir -p test-project
          cd test-project
          npm init -y
          npm install lodash@4.17.20 --save  # Has JS files to scan

      - name: Run Scanner with all files
        uses: ./
        id: scan
        with:
          scan-path: 'test-project'
          include-all-files: 'true'

      - name: Check results
        run: |
          echo "=== Scan Results ==="
          echo "Total packages: ${{ steps.scan.outputs.total-packages }}"
          
          TOTAL_FILES=$(node -e "const r = require('./test-project/binary-scan-results.json'); console.log(r.totalFiles || 0)")
          TOTAL_OTHER=$(node -e "const r = require('./test-project/binary-scan-results.json'); console.log(r.totalOther || 0)")
          TOTAL_METADATA=$(node -e "const r = require('./test-project/binary-scan-results.json'); console.log(r.totalMetadata || 0)")
          
          echo "Total files: $TOTAL_FILES"
          echo "Other files (JS, etc): $TOTAL_OTHER"
          echo "Metadata files: $TOTAL_METADATA"
          
          if [ "$TOTAL_OTHER" -eq "0" ]; then
            echo "::error::Expected 'other' files (JS, MD, etc) to be included"
            exit 1
          fi

  test-vulnerable-package:
    name: Test Package with Known CVEs
    runs-on: ubuntu-latest
    needs: test-scan-only
    # Only run on push (uses API key)
    if: ${{ github.event_name == 'push' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create test project with vulnerable package
        run: |
          mkdir -p test-project
          cd test-project
          npm init -y
          # lodash 4.17.20 has known CVEs:
          # - CVE-2021-23337 (command injection)
          # - CVE-2020-28500 (prototype pollution)
          npm install lodash@4.17.20 --save
          # minimist 1.2.5 has CVE-2021-44906 (prototype pollution)
          npm install minimist@1.2.5 --save

      - name: Run Scanner with upload and package.json
        uses: ./
        id: scan
        with:
          scan-path: 'test-project'
          upload: 'true'
          include-package-json: 'true'
          api-key: ${{ secrets.UC_API_KEY }}

      - name: Show results
        run: |
          echo "=== Vulnerable Package Test ==="
          echo "Packages scanned: ${{ steps.scan.outputs.total-packages }}"
          echo "Files uploaded: ${{ steps.scan.outputs.upload-successful }}"
          echo "Files skipped: ${{ steps.scan.outputs.upload-skipped }}"
          
          echo ""
          echo "=== Packages with Known CVEs ==="
          echo "- lodash@4.17.20: CVE-2021-23337, CVE-2020-28500"
          echo "- minimist@1.2.5: CVE-2021-44906"
          
          echo ""
          echo "=== Results JSON ==="
          cat test-project/binary-scan-results.json

  test-cli-file-options:
    name: Test CLI File Options
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create test project
        run: |
          mkdir -p test-project
          cd test-project
          npm init -y
          npm install lodash@4.17.20 --save

      - name: Test CLI --include-package-json
        run: |
          node scanner.js --include-package-json test-project
          METADATA=$(node -e "const r = require('./test-project/binary-scan-results.json'); console.log(r.totalMetadata || 0)")
          echo "Metadata files: $METADATA"
          if [ "$METADATA" -eq "0" ]; then
            echo "::error::--include-package-json did not find any package.json files"
            exit 1
          fi

      - name: Test CLI --all-files
        run: |
          node scanner.js --all-files test-project
          OTHER=$(node -e "const r = require('./test-project/binary-scan-results.json'); console.log(r.totalOther || 0)")
          echo "Other files: $OTHER"
          if [ "$OTHER" -eq "0" ]; then
            echo "::error::--all-files did not find any other files"
            exit 1
          fi

      - name: Show JSON structure
        run: |
          echo "=== JSON Output Structure ==="
          node -e "const r = require('./test-project/binary-scan-results.json'); console.log(JSON.stringify({totalFiles: r.totalFiles, totalBinaries: r.totalBinaries, totalScripts: r.totalScripts, totalMetadata: r.totalMetadata, totalOther: r.totalOther, includePackageJson: r.includePackageJson, includeAllFiles: r.includeAllFiles}, null, 2))"
